<?php

// Функция для транслитерации текста (замена английских букв на русские)
function transliterateText($text) {
    $replacements = [
        // Английские буквы
        'a' => 'а', 'c' => 'с', 'e' => 'е', 'o' => 'о', 'p' => 'р', 
        'x' => 'х', 'y' => 'у', 'A' => 'А', 'B' => 'В', 'C' => 'С', 
        'E' => 'Е', 'H' => 'Н', 'K' => 'К', 'M' => 'М', 'O' => 'О', 
        'P' => 'Р', 'T' => 'Т', 'X' => 'Х', 'Y' => 'У', 'u' => 'и', 
        'U' => 'И', 'b' => 'ь', 'B' => 'Ь', 'd' => 'д', 'D' => 'Д', 
        'g' => 'д', 'G' => 'Д', 'l' => 'л', 'L' => 'Л', 'n' => 'п', 
        'N' => 'П', 's' => 'с', 'S' => 'С', 't' => 'т', 'v' => 'в', 
        'V' => 'В', 'z' => 'з', 'Z' => 'З', 'm' => 'м', 'k' => 'к', 
        'h' => 'н', 'w' => 'ш', 'W' => 'Ш', 'q' => 'к', 'Q' => 'К', 
        'j' => 'ж', 'J' => 'Ж', 'f' => 'ф', 'F' => 'Ф', 'r' => 'р', 
        'R' => 'Р', 'i' => 'и', 'I' => 'И',

        // Греческие буквы
        'α' => 'а', 'β' => 'в', 'γ' => 'г', 'δ' => 'д', 'ε' => 'е', 
        'ζ' => 'з', 'η' => 'н', 'θ' => 'т', 'ι' => 'и', 'κ' => 'к', 
        'λ' => 'л', 'μ' => 'м', 'ν' => 'н', 'ξ' => 'к', 'ο' => 'о', 
        'π' => 'п', 'ρ' => 'р', 'σ' => 'с', 'τ' => 'т', 'υ' => 'у', 
        'φ' => 'ф', 'χ' => 'х', 'ψ' => 'п', 'ω' => 'ш',

        // Немецкие, французские, испанские символы
        'ä' => 'а', 'ö' => 'о', 'ü' => 'у', 'ß' => 'б', 
        'é' => 'е', 'è' => 'е', 'ê' => 'е', 'ë' => 'е', 
        'à' => 'а', 'â' => 'а', 'ç' => 'с', 'ñ' => 'н', 
        'î' => 'и', 'ï' => 'и', 'ô' => 'о', 'œ' => 'о', 
        'ù' => 'у', 'û' => 'у', 'ÿ' => 'у',

        // Unicode символы, похожие на русские буквы
        'ᴀ' => 'а', 'ʙ' => 'в', 'ᴄ' => 'с', 'ᴅ' => 'д', 'ᴇ' => 'е', 
        'ꜰ' => 'ф', 'ɢ' => 'г', 'ʜ' => 'н', 'ɪ' => 'и', 'ᴊ' => 'ж', 
        'ᴋ' => 'к', 'ʟ' => 'л', 'ᴍ' => 'м', 'ɴ' => 'н', 'ᴏ' => 'о', 
        'ᴘ' => 'р', 'ʀ' => 'р', 'ꜱ' => 'с', 'ᴛ' => 'т', 'ᴜ' => 'у', 
        'ᴠ' => 'в', 'ᴡ' => 'ш', 'ʏ' => 'у', 'ᴢ' => 'з',
        'ᴧ' => 'п', 'ᴨ' => 'п', 'ᴩ' => 'р', 'ᴬ' => 'а', 'ᴮ' => 'в', 
        'ᴰ' => 'д', 'ᴱ' => 'е', 'ᴳ' => 'г', 'ᴴ' => 'н', 'ᴵ' => 'и', 
        'ᴶ' => 'ж', 'ᴷ' => 'к', 'ᴸ' => 'л', 'ᴹ' => 'м', 'ᴺ' => 'н', 
        'ᴼ' => 'о', 'ᴾ' => 'р', 'ᴿ' => 'р', 'ᵀ' => 'т', 'ᵁ' => 'у', 
        'ⱽ' => 'в', 'ᵂ' => 'ш',

        // Другие символы
        '¢' => 'с', '£' => 'ф', '¥' => 'у', '§' => 'с', '©' => 'с', 
        '®' => 'р', '°' => 'о', '±' => 'п', '²' => 'в', '³' => 'з', 
        'µ' => 'м', '¶' => 'п', '·' => 'т', '¹' => 'и', 'º' => 'о', 
        '»' => 'в', '¼' => 'ч', '½' => 'п', '¾' => 'з', '¿' => 'и', 
        'Æ' => 'а', 'Ð' => 'д', 'Þ' => 'т', 'æ' => 'а', 'ð' => 'д', 
        'þ' => 'т', 'Œ' => 'о', 'œ' => 'о', 'Š' => 'ш', 'š' => 'ш', 
        'Ÿ' => 'у', 'ƒ' => 'ф', 'ˆ' => 'и',
        
        // Дополнительные замены
        '◆' => '', '★' => '', '❗' => '', '➕' => '', '±' => 'п',
        '²' => 'в', '³' => 'з', 'µ' => 'м', '¶' => 'п', '·' => 'т',
        '¼' => 'ч', '½' => 'п', '¾' => 'з', '¿' => 'и', '§' => 'с'
    ];

    return strtr(mb_strtolower($text), $replacements);
}

// Функция для нормализации текста (удаление лишних пробелов и транслитерация)
function normalizeText($text) {
    $text = mb_strtolower($text);
    $text = transliterateText($text);
    $text = preg_replace('/[^\p{L}\s]/u', '', $text);
    $text = preg_replace('/\s+/u', ' ', $text);
    return trim($text);
}

// Функция для получения ответа от API
function getAIResponse($message) {
    global $apiKey, $apiUrl;

    // Данные для запроса
    $data = [
        'model' => 'deepseek-r1-zero:free',
        'messages' => [
            ['role' => 'user', 'content' => $message]
        ]
    ];

    // Настройки HTTP-запроса
    $options = [
        'http' => [
            'header'  => "Content-type: application/json\r\nAuthorization: Bearer $apiKey",
            'method'  => 'POST',
            'content' => json_encode($data),
        ],
    ];

    // Создаём контекст запроса
    $context  = stream_context_create($options);

    // Отправляем запрос
    $response = file_get_contents($apiUrl, false, $context);

    // Обработка ошибок
    if ($response === FALSE) {
        $error = error_get_last();
        return "Ошибка при запросе к API: " . $error['message'];
    }

    // Декодируем ответ
    $responseData = json_decode($response, true);

    // Проверяем, есть ли ошибка в ответе
    if (isset($responseData['error'])) {
        return "Ошибка API: " . $responseData['error']['message'];
    }

    // Проверяем, есть ли ответ
    if (!isset($responseData['choices'][0]['message']['content'])) {
        return "Не удалось получить ответ от API.";
    }

    // Возвращаем ответ
    return $responseData['choices'][0]['message']['content'];
}
